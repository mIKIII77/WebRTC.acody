\documentclass[12pt, a4paper, oneside]{Thesis}
\usepackage[utf8]{inputenc}
\usepackage{kpfonts}
\usepackage[T1]{fontenc}
\usepackage[francais]{babel}
\usepackage{graphicx}
\usepackage{lmodern}
\usepackage{datetime}
\usepackage{fancyhdr}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{pgf-umlsd}
\usepackage{pdflscape}
\usepackage{hyperref}


\newdateformat{mydate}{\THEDAY\space\monthname[\THEMONTH]\space\THEYEAR}

\lstset{
  basicstyle=\footnotesize\ttfamily,
  commentstyle=\color{gray},
  keywordstyle=\color{blue},
  stringstyle=\color{purple},
  numbers=left,
  numbersep=5pt,
  frame=single,
  rulecolor=\color{black},
  tabsize=2,
  captionpos=b,
  breaklines=true,
  breakatwhitespace=true,
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  morecomment=[l]{\#}
}

\lstdefinelanguage{JavaScript}{
  keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
  keywordstyle=\color{blue}\bfseries,
  ndkeywords={class, export, boolean, throw, implements, import, this},
  ndkeywordstyle=\color{darkgray}\bfseries,
  identifierstyle=\color{black},
  sensitive=false,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  commentstyle=\color{purple}\ttfamily,
  stringstyle=\color{red}\ttfamily,
  morestring=[b]',
  morestring=[b]"
}

\renewcommand{\lstlistingname}{}
\renewcommand{\thesection}{\arabic{section}}

\usepackage{fancyhdr}
\usepackage{lastpage} % Ajouter pour le référencement de la dernière page

\fancypagestyle{plain}{
  \fancyhf{} % clear all header and footer fields for the first page
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

\pagestyle{fancy}
\fancyhf{} % clear all header and footer fields
\fancyhead{} % efface le contenu du haut de page
\fancyfoot[L]{Rapport SAE5.ROM.03} % Gauche du pied de page
\fancyfoot[C]{\thepage/\pageref{LastPage}} % Numéro de page / Total de pages au centre du pied de page
\fancyfoot[R]{PLUVIOSE - KARAPETYAN} % Droite du pied de page
\renewcommand{\headrulewidth}{0pt} % Pas de ligne en haut de page
\renewcommand{\footrulewidth}{0pt} % Pas de ligne en bas de page

\newcommand{\newthreadShift}[4][gray!30]{
  \newinst[#4]{#2}{#3}
  \stepcounter{threadnum}
  \node[below of=inst\theinstnum,node distance=0.8cm] (thread\thethreadnum) {};
  \tikzstyle{threadcolor\thethreadnum}=[fill=#1]
  \tikzstyle{instcolor#2}=[fill=#1]
}

\usepackage{titlesec}

% Aligner les titres à gauche
\titleformat{\section}
  {\normalfont\Large\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}
  {\normalfont\large\bfseries}{\thesubsection}{1em}{}
\titleformat{\subsubsection}
  {\normalfont\normalsize\bfseries}{\thesubsubsection}{1em}{}

% Justifier le texte des titres si nécessaire
\titlespacing*{\section}
  {0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}
\titlespacing*{\subsection}
  {0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
\titlespacing*{\subsubsection}
  {0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\begin{document}

\author{PLUVIOSE Louis - KARAPETYAN Mikhail}

\begin{center}
{\LARGE \textbf{Rapport SAE5.ROM.03}}

\vspace{1cm}

{\Large {PLUVIOSE Louis - KARAPETYAN Mikhail}}

\vspace{1cm}

{\LARGE \textbf{Application de communication WebRTC}}

\vspace{2cm}

\includegraphics[width=7.5cm]{images/logo-iut-colmar.jpg}

\vspace{0.5cm}

\includegraphics[width=7.5cm]{images/logo-but-rt.png}

\vspace{2cm}

\textbf{Sujet proposé par : Monsieur Philipe Hensel} \\

\vspace{1cm}

Université de Haute-Alsace \\
Institut Universitaire de Technologie de Colmar \\
Département Réseaux et Télécommunications \\

\vspace{3cm}

{\large \mydate\today}

\end{center}

\newpage

\tableofcontents

\lstlistoflistings

\listoffigures

\newpage

\section{Introduction}

Dans un monde de plus en plus connecté, la communication en temps réel via Internet est devenue une nécessité cruciale, tant pour les interactions personnelles que professionnelles. Notre projet pour la SAE5.ROM.03, s'inscrit dans cette dynamique en offrant une solution de communication basée sur la technologie WebRTC (Web Real-Time Communication). Nous avons voulu via ce projet nous lancer un défi : celui de permettre des échanges audio et vidéo en temps réel directement depuis le navigateur web, sans nécessité de télécharger des logiciels tiers ou de créer des comptes d'utilisateur.\\

La technologie WebRTC, un standard ouvert et gratuit, permet de réaliser des appels vidéo et audio de haute qualité avec une faible latence, garantissant ainsi une communication fluide et efficace. Notre application SAE5.ROM.03 est conçue pour être intuitive et facilement accessible, offrant une interface utilisateur élégante et des fonctionnalités adaptées à divers contextes, que ce soit pour des réunions, des sessions de travail collaboratif, ou des conversations personnelles.\\

L'accent est mis sur la facilité d'utilisation. Les utilisateurs peuvent créer et rejoindre des salles de conférence virtuelles en quelques clics, tout en bénéficiant d'une connexion fiable. De plus, l'application prend en charge plusieurs participants.
\newpage

\section{Diagrammes de séquence}

\subsection{Connexion à la salle de réunion}

\begin{sequencediagram}
  \newthread{c1}{Client 1}
  \newinst[3]{s}{Server}
  \newthreadShift{c2}{Client 2}{3cm}

   % Connexion du client 1 et jointure à une salle
   \begin{sdblock}{Join Room}{Client 1 rejoins une salle de vidéo conférence}
    \begin{call}{c1}{join(roomId)}{s}{}
    \end{call}
  \end{sdblock}

  % Connexion du client 2 à la même salle
  \begin{sdblock}{Join Room}{Client 2 rejoins une salle de vidéo conférence}
    \begin{call}{c2}{join(roomId)}{s}{}
    \end{call}

  \end{sdblock}

  % Le serveur notifie le Client 2
  \begin{messcall}{s}{new\_peer}{c2}
  \end{messcall}

  % Le serveur notifie le Client 2
  \begin{messcall}{s}{new\_peer}{c1}
  \end{messcall}
\end{sequencediagram}

\newpage

\subsection{Connection WebRTC}

\begin{sequencediagram}
  \newthread{c1}{Client 1}
  \newinst[3]{s}{Server}
  \newthreadShift{c2}{Client 2}{3cm}

  \begin{sdblock}{WebRTC Connection}{Échange d'offres et de réponses pour la diffusion de vidéos}
    \begin{call}{c1}{createOffer()}{c1}{offer}
    \end{call}
    \begin{call}{c1}{setLocalDescription(offer)}{c1}{}
    \end{call}
    \begin{messcall}{c1}{offer}{s}
    \end{messcall}
    \begin{messcall}{s}{offer}{c2}
    \end{messcall}

    % Client 2 crée une réponse
    \begin{call}{c2}{createAnswer()}{c2}{answer}
    \end{call}
    \begin{call}{c2}{setLocalDescription(answer)}{c2}{}
    \end{call}
    \begin{messcall}{c2}{answer}{s}
    \end{messcall}
    \begin{messcall}{s}{answer}{c1}
    \end{messcall}
  \end{sdblock}
\end{sequencediagram}

\newpage

\subsection{Échanges de candidats ICE}

\begin{sequencediagram}
  \newthread{c1}{Client 1}
  \newinst[3]{s}{Server}
  \newthreadShift{c2}{Client 2}{3cm}

  % ICE Candidate exchange
  \begin{sdblock}{ICE Candidate Exchange}{}
    \begin{messcall}{c1}{ICE Candidate}{s}
    \end{messcall}
    \begin{messcall}{s}{ICE Candidate}{c2}
    \end{messcall}
    \begin{messcall}{c2}{ICE Candidate}{s}
    \end{messcall}
    \begin{messcall}{s}{ICE Candidate}{c1}
    \end{messcall}
  \end{sdblock}

  % Streaming video
  \begin{messcall}{c1}{stream video/audio}{c2}
  \end{messcall}
  \begin{messcall}{c2}{stream video/audio}{c1}
  \end{messcall}

  % Hang up or disconnect
  \begin{messcall}{c1}{disconnect}{s}
  \end{messcall}
  \begin{messcall}{s}{disconnect}{c2}
  \end{messcall}
\end{sequencediagram}

\newpage

\subsection{fonctionnalités supplémentaires}

\begin{sequencediagram}

  \newthread{c1}{Client 1}
  \newinst[3]{s}{Server}
  \newthreadShift{c2}{Client 2}{3cm}
  % Additional interactions based on the given code
  \begin{sdblock}{Additional Interactions}{}
    \begin{messcall}{c1}{toggleMicrophone}{c1}
    \end{messcall}
    \begin{messcall}{c1}{toggleCamera}{c1}
    \end{messcall}
    \begin{messcall}{c2}{toggleMicrophone}{c2}
    \end{messcall}
    \begin{messcall}{c2}{toggleCamera}{c2}
    \end{messcall}
  \end{sdblock}

\end{sequencediagram}

\newpage

\section{Utilisation de l'application}

\newpage

\section{Fonctionnement de l'application}

\subsection{DOM Elements}

Cette section récupère et stocke des références à divers éléments du DOM qui seront manipulés ou utilisés tout au long du script.\\

\begin{lstlisting}[language=JavaScript, caption={DOM Elements}, label=DOM Elements]
  const roomSelectionContainer = document.getElementById('room-selection-container');
  const roomInput = document.getElementById('room-input');
  const connectButton = document.getElementById('connect-button');
  const videoChatContainer = document.getElementById('video-chat-container');
  const localVideoComponent = document.getElementById('local-video');
\end{lstlisting}

\newpage

\subsection{Variables}

\begin{lstlisting}[language=JavaScript, caption={Variables}, label=Variables]
  const socket = io();
  const mediaConstraints = { audio: true, video: { width: 1280, height: 720 } };
  let localStream;
  let roomId;
  let peerConnections = {}; // Dictionary to hold all peer connections
  
  const iceServers = {
      iceServers: [
          { urls: 'stun:stun.l.google.com:19302' }, // Serveur STUN existant
          // Ajout de la configuration TURN
          {
              urls: 'turn:relay1.expressturn.com:3478', // URL du serveur TURN
              username: 'efJJ0L80U0GANH5V0A', // Nom d'utilisateur
              credential: 'LO5Tdr8aoKohTHDL' // Mot de passe
          }
      ]
  };
\end{lstlisting}

\begin{itemize}
  \item \verb|socket| : Crée une connexion socket.io pour la communication en temps réel avec le serveur.
  \item \verb|mediaConstraints| : Spécifie les contraintes des médias (audio et vidéo) pour WebRTC.
  \item \verb|localStream| : Représente le flux média local (audio et vidéo) de l'utilisateur.
  \item \verb|roomId| : Stocke l'ID de la salle de chat actuelle.
  \item \verb|peerConnections| : Un dictionnaire pour stocker les connexions peer WebRTC.
  \item \verb|iceServers| : Contient les serveurs STUN et TURN utilisés pour la traversée de NAT et le relais.
\end{itemize}

\newpage

\subsection{Button Listeners}

\begin{lstlisting}[language=JavaScript, caption={Button Listeners}, label=Button Listeners]
  connectButton.addEventListener('click', () => {
  joinRoom(roomInput.value);
});

const hangUpButton = document.getElementById('hangup-button');
const toggleMicButton = document.getElementById('toggle-mic-button');
const toggleCameraButton = document.getElementById('toggle-camera-button');

hangUpButton.addEventListener('click', hangUpCall);
toggleMicButton.addEventListener('click', toggleMicrophone);
toggleCameraButton.addEventListener('click', toggleCamera);

let isRoomCreator = false;
\end{lstlisting}

\begin{itemize}
  \item \verb|connectButton.addEventListener| : Écouteur d'événements pour le bouton de connexion pour rejoindre une salle.
  \item \verb|hangUpButton.addEventListener| : Écouteur d'événements pour le bouton de raccrochage.
  \item \verb|toggleMicButton.addEventListener| :  Écouteur d'événements pour activer/désactiver le microphone.
  \item \verb|toggleCameraButton.addEventListener| : Écouteur d'événements pour activer/désactiver la caméra.
\end{itemize}

\newpage

\subsection{Socket Event Callbacks}

\begin{lstlisting}[language=JavaScript, caption={Socket Event Callbacks}, label=Socket Event Callbacks]
  socket.on('room_created', async () => {
  console.log('Socket event callback: room_created');
  await setLocalStream(mediaConstraints);
  isRoomCreator = true;
});

socket.on('room_joined', async () => {
  console.log('Socket event callback: room_joined');
  await setLocalStream(mediaConstraints);
  isRoomCreator = false;
  socket.emit('start_call', roomId);
}); 

socket.on('full_room', () => {
  console.log('Socket event callback: full_room');
  alert('The room is full, please try another one');
});

socket.on('start_call', async () => {
  console.log('Socket event callback: start_call');
  if (isRoomCreator) {
    createPeerConnections();
  }
});

socket.on('webrtc_offer', async (data) => {
  console.log('Socket event callback: webrtc_offer');
  
  if (!localStream) {
    console.log("Waiting to set local stream before handling offer");
    await setLocalStream(mediaConstraints);
  }
  
  if (!peerConnections[data.peerId]) {
    await setupPeerConnection(data.peerId, false); // false = not an initiator
  }
  await handleOffer(data);
});

socket.on('webrtc_answer', (data) => {
  console.log('Socket event callback: webrtc_answer');
  handleAnswer(data);
});

socket.on('webrtc_ice_candidate', (data) => {
  console.log('Socket event callback: webrtc_ice_candidate');
  handleIceCandidate(data);
});

socket.on('new_peer', async (peerId) => {
  console.log('Socket event callback: new_peer');
  await createPeerConnection(peerId, false);
});
\end{lstlisting}

\begin{itemize}
  \item \verb|socket.on('room_created')| : Gère l'événement de création de salle.
  \item \verb|socket.on('room_joined')| : Gère l'événement de rejoindre une salle.
  \item \verb|socket.on('full_room')| : Gère l'événement lorsque la salle est pleine.
  \item \verb|socket.on('start_call')| : Gère le début d'un appel WebRTC.
  \item \verb|socket.on('webrtc_offer')| : Gère la réception d'une offre WebRTC.
  \item \verb|socket.on('webrtc_answer')| : Gère la réception d'une réponse WebRTC.
  \item \verb|socket.on('webrtc_ice_candidate')| : Gère la réception d'un candidat ICE.
  \item \verb|socket.on('new_peer')| : Gère l'ajout d'un nouveau pair dans la salle.
\end{itemize}

\newpage

\subsection{title}

\begin{lstlisting}[language=JavaScript, caption={Variables}, label=Variables]
  const socket = io();
  const mediaConstraints = { audio: true, video: { width: 1280, height: 720 } };
  let localStream;
  let roomId;
  let peerConnections = {}; // Dictionary to hold all peer connections
  
  const iceServers = {
      iceServers: [
          { urls: 'stun:stun.l.google.com:19302' }, // Serveur STUN existant
          // Ajout de la configuration TURN
          {
              urls: 'turn:relay1.expressturn.com:3478', // URL du serveur TURN
              username: 'efJJ0L80U0GANH5V0A', // Nom d'utilisateur
              credential: 'LO5Tdr8aoKohTHDL' // Mot de passe
          }
      ]
  };
\end{lstlisting}

\begin{itemize}
  \item \verb|socket| : Crée une connexion socket.io pour la communication en temps réel avec le serveur.
  \item \verb|mediaConstraints| : Spécifie les contraintes des médias (audio et vidéo) pour WebRTC.
  \item \verb|localStream| : Représente le flux média local (audio et vidéo) de l'utilisateur.
  \item \verb|roomId| : Stocke l'ID de la salle de chat actuelle.
  \item \verb|peerConnections| : Un dictionnaire pour stocker les connexions peer WebRTC.
  \item \verb|iceServers| : Contient les serveurs STUN et TURN utilisés pour la traversée de NAT et le relais.
    \subitem Pour obtenir un serveur TURN gratuitement et rapidement, nous avons utilisé le service ExpressTURN : \href{https://www.expressturn.com/}{https://www.expressturn.com/}. Il fournit un serveur TURN gratuit et public avec une limite de 500 MB par mois.\\
\end{itemize}

\newpage

\subsection{title}

\begin{lstlisting}[language=JavaScript, caption={Variables}, label=Variables]
  const socket = io();
  const mediaConstraints = { audio: true, video: { width: 1280, height: 720 } };
  let localStream;
  let roomId;
  let peerConnections = {}; // Dictionary to hold all peer connections
  
  const iceServers = {
      iceServers: [
          { urls: 'stun:stun.l.google.com:19302' }, // Serveur STUN existant
          // Ajout de la configuration TURN
          {
              urls: 'turn:relay1.expressturn.com:3478', // URL du serveur TURN
              username: 'efJJ0L80U0GANH5V0A', // Nom d'utilisateur
              credential: 'LO5Tdr8aoKohTHDL' // Mot de passe
          }
      ]
  };
\end{lstlisting}

\begin{itemize}
  \item \verb|socket| : Crée une connexion socket.io pour la communication en temps réel avec le serveur.
  \item \verb|mediaConstraints| : Spécifie les contraintes des médias (audio et vidéo) pour WebRTC.
  \item \verb|localStream| : Représente le flux média local (audio et vidéo) de l'utilisateur.
  \item \verb|roomId| : Stocke l'ID de la salle de chat actuelle.
  \item \verb|peerConnections| : Un dictionnaire pour stocker les connexions peer WebRTC.
  \item \verb|iceServers| : Contient les serveurs STUN et TURN utilisés pour la traversée de NAT et le relais.
\end{itemize}

\newpage

\subsection{title}

\subsection{title}

\subsection{title}

\subsection{title}

\newpage

\section{Annexes}

\subsection{Sous-titre 1}


Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse auctor elit vitae mauris dignissim bibendum. Fusce facilisis, sapien sed varius finibus, quam lacus auctor lorem, ac dapibus sapien ante quis odio. Sed tincidunt pharetra dui, in ultricies enim tincidunt ac. Suspendisse quis tincidunt justo. Duis interdum vitae ipsum ac venenatis. Nullam bibendum ex ac nisl tristique, vel euismod ex faucibus.\\

\subsection{Sous-titre 2}

\begin{lstlisting}[language=Python, caption={Exemple de code Python}, label=mon-code-python]
	def hello(name):
	  print("Hello, " + name + "!")
	
	hello("World")
\end{lstlisting}

\end{document}